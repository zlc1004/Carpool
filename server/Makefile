# CarpSchool Supabase Server Makefile

.PHONY: help start stop restart status logs clean health backup restore deploy test

# Default target
help: ## Show this help message
	@echo "CarpSchool Supabase Server"
	@echo "========================="
	@echo ""
	@echo "Available commands:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}'

# Development commands
start: ## Start all services
	@echo "ðŸš€ Starting CarpSchool Supabase Server..."
	./start-dev.sh



start-proxy: ## Start all services including proxy
	@echo "ðŸš€ Starting CarpSchool Supabase Server with proxy..."
	./start-dev.sh --with-proxy

stop: ## Stop all services
	@echo "ðŸ›‘ Stopping services..."
	docker compose down

restart: ## Restart all services
	@echo "ðŸ”„ Restarting services..."
	docker compose restart

# Service management
status: ## Show status of all services
	@echo "ðŸ“Š Service Status:"
	@docker compose ps --format "table {{.Service}}\t{{.State}}\t{{.Status}}\t{{.Ports}}"

logs: ## Show logs for all services
	@docker compose logs -f

logs-db: ## Show database logs
	@docker compose logs -f supabase-db

logs-functions: ## Show Edge Functions logs
	@docker compose logs -f supabase-functions

logs-auth: ## Show auth service logs
	@docker compose logs -f supabase-auth

# Database commands
db-shell: ## Open database shell
	@docker compose exec supabase-db psql -U supabase_admin -d postgres

db-migrate: ## Apply database migrations
	@echo "ðŸ“Š Applying migrations..."
	@if [ -f "supabase/migrations/01_initial_schema.sql" ]; then \
		docker compose exec -T supabase-db psql -U supabase_admin -d postgres < supabase/migrations/01_initial_schema.sql; \
		echo "âœ… Initial schema applied"; \
	fi
	@if [ -f "supabase/migrations/02_rls_policies.sql" ]; then \
		docker compose exec -T supabase-db psql -U supabase_admin -d postgres < supabase/migrations/02_rls_policies.sql; \
		echo "âœ… RLS policies applied"; \
	fi
	@if [ -f "supabase/migrations/03_seed_data.sql" ]; then \
		docker compose exec -T supabase-db psql -U supabase_admin -d postgres < supabase/migrations/03_seed_data.sql; \
		echo "âœ… Seed data applied"; \
	fi

db-reset: ## Reset database (WARNING: destroys all data)
	@echo "âš ï¸  This will destroy ALL data. Are you sure? [y/N]"
	@read -r response; \
	if [ "$$response" = "y" ] || [ "$$response" = "Y" ]; then \
		echo "ðŸ—‘ï¸  Resetting database..."; \
		docker compose down -v; \
		./start-dev.sh; \
	else \
		echo "âŒ Database reset cancelled"; \
	fi

# Health and monitoring
health: ## Run health checks
	@./health-check.sh

health-quick: ## Run quick health checks
	@./health-check.sh --quick

health-full: ## Run full health checks
	@./health-check.sh --full

# Backup and restore
backup: ## Create full backup
	@./backup-restore.sh backup

backup-db: ## Backup database only
	@./backup-restore.sh backup-db

backup-list: ## List available backups
	@./backup-restore.sh list

# Development utilities
clean: ## Clean up stopped containers and unused images
	@echo "ðŸ§¹ Cleaning up..."
	@docker compose down
	@docker system prune -f
	@echo "âœ… Cleanup completed"

clean-all: ## Clean up everything including volumes (WARNING: destroys data)
	@echo "âš ï¸  This will destroy ALL data including volumes. Are you sure? [y/N]"
	@read -r response; \
	if [ "$$response" = "y" ] || [ "$$response" = "Y" ]; then \
		echo "ðŸ—‘ï¸  Cleaning everything..."; \
		docker compose down -v; \
		docker system prune -af; \
		docker volume prune -f; \
		echo "âœ… Everything cleaned"; \
	else \
		echo "âŒ Cleanup cancelled"; \
	fi

# Functions development
functions-restart: ## Restart Edge Functions only
	@docker compose restart supabase-functions

functions-logs: ## Show Edge Functions logs
	@docker compose logs -f supabase-functions

# Testing
test-auth: ## Test authentication endpoints
	@echo "ðŸ§ª Testing authentication endpoints..."
	@curl -s -X POST http://localhost:8000/functions/v1/main/captcha/generate | jq '.'

test-captcha: ## Test CAPTCHA generation
	@echo "ðŸ§ª Testing CAPTCHA generation..."
	@curl -s -X POST http://localhost:8000/functions/v1/main/captcha/generate | jq '.'

test-api: ## Test all API endpoints
	@echo "ðŸ§ª Testing API endpoints..."
	@echo "Main Router:"
	@curl -s http://localhost:8000/functions/v1/main | jq '.'
	@echo "\nCaptcha Generation:"
	@curl -s -X POST http://localhost:8000/functions/v1/main/captcha/generate | jq '.'

# Studio and admin
studio: ## Open Supabase Studio in browser
	@echo "ðŸŽ¨ Opening Supabase Studio..."
	@open http://localhost:3001 || xdg-open http://localhost:3001 || echo "Please open http://localhost:3001 in your browser"

studio-url: ## Show Supabase Studio URL
	@echo "ðŸŽ¨ Supabase Studio: http://localhost:3001"

email: ## Open email testing interface
	@echo "ðŸ“§ Opening email testing interface..."
	@open http://localhost:9000 || xdg-open http://localhost:9000 || echo "Please open http://localhost:9000 in your browser"

# Production deployment
deploy-check: ## Check if ready for production deployment
	@echo "ðŸ” Checking production readiness..."
	@./deploy-production.sh --check || echo "âŒ Not ready for production"

deploy: ## Deploy to production (requires environment variables)
	@echo "ðŸš€ Deploying to production..."
	@./deploy-production.sh

# Configuration
config-check: ## Check configuration files
	@echo "ðŸ”§ Checking configuration..."
	@if [ ! -f .env ]; then echo "âŒ .env file missing"; exit 1; fi
	@if [ ! -f supabase/config.toml ]; then echo "âŒ supabase/config.toml missing"; exit 1; fi
	@if [ ! -f kong.yml ]; then echo "âŒ Kong configuration missing"; exit 1; fi
	@echo "âœ… Configuration files present"

env-example: ## Show environment variables example
	@echo "ðŸ“„ Environment variables (.env):"
	@cat .env.example

# Information
info: ## Show system information
	@echo "â„¹ï¸  System Information:"
	@echo "Docker version: $$(docker --version)"
	@echo "Docker Compose version: $$(docker compose version --short)"
	@echo "Current directory: $$(pwd)"
	@echo "Available memory: $$(free -h | grep Mem | awk '{print $$2}')"
	@echo "Available disk: $$(df -h . | awk 'NR==2 {print $$4}')"

urls: ## Show all service URLs
	@echo "ðŸŒ Service URLs:"
	@echo "Supabase Studio:    http://localhost:3001"
	@echo "Supabase API:       http://localhost:8000"
	@echo "Email Testing:      http://localhost:9000"
	@echo "Database:           localhost:5432"
	@echo "Functions:          http://localhost:8000/functions/v1/main"
	@echo ""
	@echo "Optional Services:"
	@echo "Nominatim:          http://localhost:40060"
	@echo "Tileserver:         http://localhost:40061"
	@echo "OSRM:              http://localhost:40062"
	@echo "CodePush API:      http://localhost:40064"
	@echo "CodePush Admin:    http://localhost:40065"

# Quick development workflow
dev: ## Start development environment and show status
	@$(MAKE) start
	@sleep 5
	@$(MAKE) status
	@$(MAKE) urls

# Documentation
docs: ## Open documentation
	@echo "ðŸ“š Documentation:"
	@echo "README:           cat README.md"
	@echo "API Endpoints:    See README.md#api-endpoints"
	@echo "Supabase Docs:    https://supabase.com/docs"
