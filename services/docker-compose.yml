services:
  tileserver-gl:
    image: "maptiler/tileserver-gl:latest"
    container_name: tileserver-gl
    command:
      - --port
      - "8082"
      - --config
      - "/style/config.json"
    volumes:
      - ../server/openmaptilesdata/data:/data
      - ../server/openmaptilesdata/style:/style
      - ../server/openmaptilesdata/build:/build
    restart: unless-stopped
    networks:
      - carpool_network
    healthcheck:
      test:
        ["CMD", "node", "-e", "require('net').connect({host: '127.0.0.1', port: 8082}).on('connect',()=>process.exit(0)).on('error',()=>process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  nominatim:
    container_name: nominatim
    image: mediagis/nominatim:5.1
    environment:
      - PBF_PATH=/nominatim/data/north-america/canada/${REGION:-british-columbia}.osm.pbf
    volumes:
      - ../server/openmaptilesdata/data:/nominatim/data
      - ../server/pgdataNominatimInternal:/var/lib/postgresql/16/main
    restart: unless-stopped
    networks:
      - carpool_network
    healthcheck:
      test: ["CMD", "curl", "--silent", "--show-error", "--output", "/dev/null", "http://127.0.0.1:8080/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  osrm:
    container_name: osrm
    image: ghcr.io/project-osrm/osrm-backend
    command: osrm-routed --algorithm mld /data/${REGION:-british-columbia}.osrm --port 8083
    volumes:
      - ../server/osrmdata/data:/data
    restart: unless-stopped
    networks:
      - carpool_network
    healthcheck:
      test: ["CMD", "sh", "-c", "nc -z 127.0.0.1 8083"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  carpool_network:
    external: true
